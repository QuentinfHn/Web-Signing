<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>LED Display</title>

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
}

#stage {
  position: relative;
  width: 100%;
  height: 100%;
}

.screen {
  position: absolute;
  overflow: hidden;
}

.screen img {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: contain;
}
</style>
</head>

<body>
<div id="stage"></div>

<script>
/* ================================
   DISPLAY CONFIG
================================ */
const params = new URLSearchParams(window.location.search);
const DISPLAY_ID = params.get('display') || 'display1';
const FADE_TIME = 500; // ms

const socket = new WebSocket("ws://localhost:8080");

const screens = {};           // screenId -> img element
let layoutReady = false;
let pendingMessages = [];

/* ================================
   LOAD LAYOUT
================================ */
fetch('/layout.json')
  .then(r => r.json())
  .then(layout => {
    layout.screens
      .filter(s => s.display === DISPLAY_ID)
      .forEach(s => {
        const div = document.createElement('div');
        div.className = 'screen';
        div.style.left = s.x + 'px';
        div.style.top = s.y + 'px';
        div.style.width = s.width + 'px';
        div.style.height = s.height + 'px';

        const img = document.createElement('img');
        img.style.opacity = 0;
        img.style.transition = `opacity ${FADE_TIME}ms ease-in-out`;

        div.appendChild(img);
        document.getElementById('stage').appendChild(div);

        screens[s.id] = img;
      });

    layoutReady = true;
    pendingMessages.forEach(handleMessage);
    pendingMessages = [];
  });

/* ================================
   FADE HELPER
================================ */
function fadeImage(oldImg, src) {
  if (!oldImg) return;

  const parent = oldImg.parentElement;

  const newImg = document.createElement('img');
  newImg.src = src + '?t=' + Date.now();
  newImg.style.opacity = 0;
  newImg.style.transition = `opacity ${FADE_TIME}ms ease-in-out`;
  newImg.style.width = '100%';
  newImg.style.height = '100%';
  newImg.style.objectFit = 'contain';
  newImg.style.position = 'absolute';

  parent.appendChild(newImg);

  requestAnimationFrame(() => {
    newImg.style.opacity = 1;
    oldImg.style.opacity = 0;
  });

  setTimeout(() => {
    parent.removeChild(oldImg);
    Object.keys(screens).forEach(id => {
      if (screens[id] === oldImg) screens[id] = newImg;
    });
  }, FADE_TIME);
}

/* ================================
   HANDLE STATE
================================ */
function handleMessage(msg) {
  if (msg.type !== 'state') return;

  Object.entries(msg.screens).forEach(([id, state]) => {
    if (!screens[id]) return;
    if (state.src) {
      fadeImage(screens[id], state.src);
    }
  });
}

/* ================================
   WEBSOCKET
================================ */
socket.onopen = () => console.log("Display WS connected");
socket.onerror = err => console.error("Display WS error:", err);
socket.onclose = () => console.warn("Display WS closed");
socket.onmessage = e => {
  (async () => {
    try {
      let data = e.data;
      if (data instanceof Blob) data = await data.text();
      console.log("Display received WS message:", data);

      const msg = JSON.parse(data);
      if (!layoutReady) {
        pendingMessages.push(msg);
      } else {
        handleMessage(msg);
      }
    } catch(err) {
      console.error("Error handling WS message:", err);
    }
  })();
};
</script>
</body>
</html>
