<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>LED Screen Map</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
#map {
  width: 100vw;
  height: 100vh;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([52.370216, 4.895168], 16);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

const markers = {};
const screenMeta = {};

const socket = new WebSocket("ws://localhost:8080");

// laad layout (GPS + namen)
fetch('/layout.json')
  .then(r => r.json())
  .then(layout => {
    layout.screens.forEach(s => {
      if (!s.meta?.lat || !s.meta?.lng) return;

      const marker = L.marker([s.meta.lat, s.meta.lng])
        .addTo(map)
        .bindPopup(s.meta.name); // alleen de schermnaam

      markers[s.id] = marker;
      screenMeta[s.id] = s.meta;
    });
  });

// live state
socket.onmessage = async e => {
  let data = e.data;
  if (data instanceof Blob) data = await data.text();
  const msg = JSON.parse(data);

  if (msg.type === 'state') {
    Object.entries(msg.screens).forEach(([id, state]) => {
      const marker = markers[id];
      const meta = screenMeta[id];

      if (marker && meta) {
        // popup = schermnaam + thumbnail + update-tijd
        marker.setPopupContent(`
          <strong>${meta.name}</strong><br>
          <img src="${state.src}" width="120"><br>
          ${new Date(state.updated).toLocaleTimeString()}
        `);
      }
    });
  }
};
</script>
</body>
</html>
