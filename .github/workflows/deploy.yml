name: Deploy to Droplet

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  deployments: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create GitHub Deployment
        id: create_deployment
        run: |
          # Create deployment payload with proper JSON for empty array
          jq -n \
            --arg ref "${{ github.ref }}" \
            --arg repo "${{ github.repository }}" \
            '{
              ref: $ref,
              environment: "production",
              required_contexts: [],
              auto_merge: false
            }' > payload.json
          
          # Create a new deployment record
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments \
            --input payload.json \
            > deployment.json
          
          # Extract ID for status updates
          echo "DEPLOYMENT_ID=$(jq .id deployment.json)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Deployment Status (In Progress)
        if: success()
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments/${{ steps.create_deployment.outputs.DEPLOYMENT_ID }}/statuses \
            -f state='in_progress' \
            -f description='Deployment passed to server...'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy via SSH (Native)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          SSH_HOST: ${{ secrets.SERVER_HOST }}
          SSH_USER: ${{ secrets.SERVER_USER }}
        run: |
          mkdir -p ~/.ssh/
          
          # Setup SSH Agent
          eval $(ssh-agent -s)
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
          
          # Disable host key checking for automation (or add known_hosts if preferred)
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          
          # Debug: Test connection
          echo "Testing connection..."
          ssh -o ConnectTimeout=10 -T "$SSH_USER@$SSH_HOST" "echo 'SSH Connection Successful'"
          
          # Execute Deployment
          echo "Executing deployment script..."
          ssh -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=5 "$SSH_USER@$SSH_HOST" "
            set -e
            cd /opt/signage-led
            git fetch origin main
            git reset --hard origin/main
            chmod +x deploy/deploy.sh
            ./deploy/deploy.sh
          "

      - name: Set Deployment Status (Success)
        if: success()
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments/${{ steps.create_deployment.outputs.DEPLOYMENT_ID }}/statuses \
            -f state='success' \
            -f description='Deployment completed successfully.' \
            -f environment_url='http://${{ secrets.SERVER_HOST }}'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Deployment Status (Failure)
        if: failure() && steps.create_deployment.outputs.DEPLOYMENT_ID
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments/${{ steps.create_deployment.outputs.DEPLOYMENT_ID }}/statuses \
            -f state='failure' \
            -f description='Deployment process failed.'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
