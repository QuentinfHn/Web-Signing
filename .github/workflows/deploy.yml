name: Deploy to Droplet

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - "frontend/**"
      - "deploy/**"
      - "docker-compose.yml"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

concurrency:
  group: deploy-production-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/quentinfhn/signing

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      deployments: write
    outputs:
      deployment_id: ${{ steps.create_deployment.outputs.DEPLOYMENT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create GitHub Deployment
        id: create_deployment
        run: |
          jq -n \
            --arg ref "${{ github.ref }}" \
            '{
              ref: $ref,
              environment: "production",
              required_contexts: [],
              auto_merge: false
            }' > payload.json
          
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments \
            --input payload.json \
            > deployment.json
          
          echo "DEPLOYMENT_ID=$(jq .id deployment.json)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Deployment Status (In Progress)
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments/${{ steps.create_deployment.outputs.DEPLOYMENT_ID }}/statuses \
            -f state='in_progress' \
            -f description='Building Docker images...'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start backend build timer
        id: backend_timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Build and push backend
        id: backend_build
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/backend:latest,${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,scope=backend,mode=max

      - name: Record backend build metrics
        if: always()
        run: |
          end=$(date +%s)
          start=${{ steps.backend_timer.outputs.start }}
          duration=$((end - start))
          {
            echo "### Backend image"
            echo "- Duration: ${duration}s"
            echo "- Digest: ${{ steps.backend_build.outputs.digest }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Start frontend build timer
        id: frontend_timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Build and push frontend
        id: frontend_build
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ env.IMAGE_PREFIX }}/frontend:latest,${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,scope=frontend,mode=max

      - name: Record frontend build metrics
        if: always()
        run: |
          end=$(date +%s)
          start=${{ steps.frontend_timer.outputs.start }}
          duration=$((end - start))
          {
            echo "### Frontend image"
            echo "- Duration: ${duration}s"
            echo "- Digest: ${{ steps.frontend_build.outputs.digest }}"
          } >> "$GITHUB_STEP_SUMMARY"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Deploy via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          SSH_HOST: ${{ secrets.SERVER_HOST }}
          SSH_USER: ${{ secrets.SERVER_USER }}
        run: |
          mkdir -p ~/.ssh/
          eval $(ssh-agent -s)
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          
          for i in {1..5}; do
            echo "Attempt $i of 5..."
            if ssh -v -o ConnectTimeout=60 -o ServerAliveInterval=60 -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "
              echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
              set -e
              cd /opt/signage-led
              git fetch origin main
              git reset --hard origin/main
              chmod +x deploy/deploy.sh
              ./deploy/deploy.sh
            "; then
              echo "Deployment successful!"
              exit 0
            fi
            echo "SSH connection failed. Retrying in 15 seconds..."
            sleep 15
          done
          echo "Failed to connect after 5 attempts."
          exit 1

      - name: Set Deployment Status (Success)
        if: success()
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments/${{ needs.build-and-push.outputs.deployment_id }}/statuses \
            -f state='success' \
            -f description='Deployment completed successfully.' \
            -f environment_url='http://${{ secrets.SERVER_HOST }}'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Deployment Status (Failure)
        if: failure()
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments/${{ needs.build-and-push.outputs.deployment_id }}/statuses \
            -f state='failure' \
            -f description='Deployment failed.'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
